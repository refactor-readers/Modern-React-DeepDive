# 11장. Next.js 13과 리액트 18
Next.js 13은 리액트 18을 전면적으로 채택하며 서버 사이드 렌더링(SSR) 구조와 레이아웃 시스템에 큰 변화를 가져왔습니다.

## 11.1 app 디렉터리의 등장
기존 pages 디렉터리 기반의 라우팅 시스템이 app 디렉터리로 변경되었습니다.

배경: 기존에는 _app.js, _document.js 파일 외에는 페이지 공통 레이아웃을 유지하기 어려웠고, 페이지별로 서로 다른 레이아웃을 적용하는 데 제약이 있었습니다.

변화: app 디렉터리 내부에 파일 시스템 기반 라우팅을 적용하면서 레이아웃(layout.js)을 중첩하여 구성할 수 있게 되었습니다.

### 11.1.1 라우팅
폴더 기반 라우팅: /app/a/b는 /a/b로 변환되며, 폴더명이 주소가 됩니다. 파일명은 라우팅 명칭에 영향을 주지 않습니다.

주요 예약어 파일:
layout.js: 해당 경로와 하위 경로에 적용되는 공통 레이아웃을 정의합니다. 루트의 layout.js는 <html>, <body> 태그를 포함해야 하며 기존 _app, _document를 대체합니다.

- page.js: 해당 경로의 UI를 담당하는 컴포넌트입니다. export default로 내보내야 합니다.
- error.js: 해당 라우팅 세그먼트의 에러 UI를 정의합니다. 클라이언트 컴포넌트('use client')여야 합니다.
- not-found.js: 404 에러 발생 시 렌더링할 UI입니다.
- loading.js: 리액트 Suspense를 기반으로 로딩 중 상태를 표시합니다.
- route.js: API 엔드포인트를 정의합니다. GET, POST 등의 메서드명을 함수로 내보내어 사용합니다.

## 11.2 리액트 서버 컴포넌트
서버와 클라이언트 모두에서 컴포넌트를 렌더링할 수 있는 기법으로, Next.js 13의 핵심입니다.

### 11.2.1 기존 리액트 컴포넌트와 서버 사이드 렌더링의 한계
기존 SSR은 초기 HTML을 빠르게 보여주지만, 결국 클라이언트에서 거대한 JS 번들을 다운로드하고 실행(Hydration)해야 상호작용이 가능했습니다. 이는 "Time to Interactive"를 늦추는 원인이 되었습니다.

### 11.2.2 서버 컴포넌트란?
서버 컴포넌트: 서버에서만 실행되므로 번들 크기에 영향을 주지 않습니다. useState, useEffect 등 상태나 효과를 사용할 수 없고, DOM API에 접근할 수 없습니다. 대신 DB나 파일 시스템에 직접 접근할 수 있습니다.

클라이언트 컴포넌트: 브라우저에서 실행되며, 'use client'를 선언하여 사용합니다. 상호작용이 필요한 경우 사용합니다.

### 11.2.3 서버 사이드 렌더링과 서버 컴포넌트의 차이
SSR: 페이지 전체를 HTML로 렌더링 후 클라이언트에 전송 (초기 로딩 속도 개선).

서버 컴포넌트: 컴포넌트 단위로 서버에서 렌더링 후 직렬화된 JSON 형태로 전송. 클라이언트 상태를 유지하면서 부분적으로 업데이트가 가능합니다.

### 11.2.4 서버 컴포넌트는 어떻게 작동하는가?
서버는 렌더링 요청을 받으면 컴포넌트를 JSON(와이어 포맷)으로 직렬화하여 스트리밍합니다. 브라우저는 이를 받아 리액트 트리를 재구성합니다.

## 11.3 Next.js에서의 리액트 서버 컴포넌트
Next.js 13의 app 디렉터리 내 모든 컴포넌트는 기본적으로 서버 컴포넌트입니다.

### 11.3.1 새로운 fetch 도입과 getServerSideProps 삭제

getServerSideProps, getStaticProps가 삭제되고 표준 Web API인 fetch를 확장하여 사용합니다.

요청 중복 제거(deduping)가 자동으로 지원되어, 트리 내 여러 곳에서 동일한 데이터를 요청해도 한 번만 호출됩니다.

### 11.3.2 정적 렌더링과 동적 렌더링
fetch 옵션으로 렌더링 방식을 제어합니다.

- fetch(url, { cache: 'force-cache' }): 정적 페이지 생성 (기본값).
- fetch(url, { cache: 'no-store' }): 매 요청마다 서버에서 데이터 불러오기 (SSR과 유사).
- generateStaticParams: 동적 라우팅에서 정적 페이지를 미리 생성할 파라미터를 정의합니다 (getStaticPaths 대체).

### 11.3.3 캐시와 mutating, 그리고 revalidating

revalidate: fetch 옵션이나 페이지 레벨 변수로 데이터 유효 시간을 설정합니다 (ISR 구현).
router.refresh(): 클라이언트 상태를 유지하면서 서버 데이터를 새로고침합니다.

### 11.3.4 스트리밍을 활용한 점진적인 페이지 불러오기

loading.js나 Suspense를 활용해 페이지 전체가 준비될 때까지 기다리지 않고, 렌더링된 부분부터 점진적으로 클라이언트에 전송하여 TTFB(Time To First Byte)와 FCP(First Contentful Paint)를 개선합니다.

## 11.4 웹팩의 대항마, 터보팩의 등장(beta)
Rust 기반으로 작성된 번들러로, 웹팩 대비 최대 700배 빠릅니다. 현재는 개발 모드(next dev --turbo)에서만 제한적으로 사용 가능합니다.

## 11.5 서버 액션(alpha)
API 엔드포인트를 따로 만들지 않고 함수 수준에서 서버 로직을 직접 실행하는 기능입니다.

'use server' 지시자를 사용하여 정의합니다.

폼의 action 속성이나 이벤트 핸들러에서 직접 호출하여 데이터 변이(Mutation)를 수행할 수 있습니다.

## 11.6 그 밖의 변화
미들웨어 강화, SEO 기능 개선, 내부 링크 분석 기능 등이 추가되었습니다