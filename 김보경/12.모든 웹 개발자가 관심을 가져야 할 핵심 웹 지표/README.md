# 12. 모든 웹 개발자가 관심을 가져야 할 핵심 웹 지표

## 12.1. 웹사이트와 성능

- 사용자가 웹사이트에 접속했을 대 공통적으로 기대하는 사항에는 무엇이 있을까요?
  - 첫 번째로는 웹사이트를 방문한 목적을 쉽게 달성할 수 있어야 하고,
  - 두 번째로는 첫 번째 목적을 달성하는 데 걸리는 시간이 짧아야 하며,
  - 마지막으로는 웹사이트에서 개인정보가 누출되는 등의 사고 없이 보안이 철저해야 합니다.
  - 크게 이 세가지만 달성할 수 있다면 웹사이트가 내부적으로 어떤 코드로 어떻게 이루어져 있는지는 고객들에게 전혀 중요하지 않습니다.
- 아무리 좋은 프레임워크라고 해도, 그리고 그 중요성을 제아무리 설파하더라도 웹사이트의 성능이 뒤떨어지면 개발자를 제외한 실제 서비스 이용자들의 호응을 얻기란 어렵습니다.
- 모든 서비스가 그렇듯 웹서비스도 마찬가지로 사용자가 느끼는 성능이 가장 중요합니다.
- 그러나 많은 개발자들이 이러한 성능에 대해 크게 관심을 기울이지 않는 것 또한 사실입니다.
  - 첫 번째로는 개발자의 기기는 대부분 일반적인 사용자의 평균적인 기기보다 성능이 뛰어나기 때무네 이러한 문제를 대체로 느끼지 못한다는 점입니다. (네트워크 환경 또한)
  - 두 번째로는 성능을 개선하는 작업은 새로운 기능을 개발하는 것보다 쉽지도, 재밌지도 않고, 서비스를 개발하는 작업 대비 눈에 띄는 성능 향상을 기대하기도 어렵다는 점입니다.
- 그럼에도 웹사이트 개발자라면 자신이 만들고자 하는 프로덕드를 어떤 기술로 어떻게 만들 것인지에 대해 신경 쓰는 것만큼 웹사이트의 성능에도 주의를 기울여야 합니다.
  - 웹사이트 성능 또한 개발자의 책임이며, 웹사이트의 성능은 조직을 이루고자 하는 목표와 직결된다고 보아도 무방합니다.

## 12.2. 핵심 웹 지표란?

- 핵심 웹 지표(외국에서는 Core Web Vital로 알려져 있습니다)란 구글에서 만든 지표로, 웹사이트에서 뛰어난 사용자 경험을 제공하는 데 필수적인 지표를 일컫는 용어입니다.
- 구글에서는 핵심 웹 지표로 꼽는 지표는 아래와 같습니다.
  - 최대 콘텐츠풀 페인트 (LCP: Largest Contentful Paint)
  - 최초 입력 지연 (FID: First Input Delay)
  - 누적 레이아웃 이동 (CLS: Cumulative Layout Shift)
- 그리고 다음 두 지표는 핵심까지는 아니지만, 특정 문제를 진단하는데 사용될 수 있다고 언급되어있습니다.
  - 최초 바이트까지의 시간 (TTFB: Time To First Byte)
  - 최초 콘텐츠풀 시간 (FCP: First Contentful Paint)

## 12.3. 최대 콘텐츠풀 페인트 LCP

### 12.3.1. 정의

- 최대 콘텐츠풀 페인트란 **"페이지가 처음 로드를 시작한 시점부터 뷰포트 내부에서 가장 큰 이미지 또는 텍스트를 렌더링하는데 걸리는 시간"**을 이야기합니다.
- 뷰포트는 사용자에게 현재 노출되는 화면을 의미합니다. 사용자에게 노출되는 영역은 기기에 의존하므로 뷰포트 크기는 기기마다 다릅니다.
- 그리고 이 뷰포트 내부에서 "큰 이미지와 텍스트"는 다음과 같이 정의되어 있습니다.
  - `<img>`
  - `<svg>` 내부의 `<image>`
  - poster 속성을 사용하는 `<video>`
  - url()을 통해 불러온 배경 이미지가 있는 요소
  - 텍스트와 같이 인라은 텍스트 요소를 포함하고 있는 블록 레벨 요소
    - 이 블록 레벨 요소에는 `<p>`, `<div>` 등이 포함됩니다.
- 이미지와 텍스트가 각각 사용자의 시점에 언제 노출되었는지를 확인하는 정확한 시점은 W3C 문서에 작성되어 있습니다.
  - 기술적인 순서로 언급되어 있지만 요약하자면 각 엘리먼트가 등장한 시점부터 텍스트 또는 이미지가 완전히 로딩되는 시점으로 보면 됩니다.
- **즉, 최대 콘텐츠풀 페인트란 사용자 기기가 노출하는 뷰포트 내부에서 가장 큰 영역을 차지하는 요소가 렌더링되는데 얼마나 걸리는지를 측정하는 지표인 것입니다.**
  - 가장 큰 요소로 고려되는 것은 앞의 5개이며, 실제 크기가 크다고 하더라도 뷰포트 영역 밖에 넘치는 요소가 있다면 해당 영역의 크기는 고려되지 않습니다.

### 12.3.4. 기준 점수

- 최대 콘텐츠풀 페인트에서 좋은 점수란 해당 지표가 2.5초 내로 응답이 오는 것입니다.
- 4초 이내로 응답이 나온다면 보통, 그 이상이 걸리면 나쁨으로 판단됩니다.
  > 지금 구현중인 도메인에서는 LCP 1.8, CLS 0.71로 레이아웃 쉬프트가 많이 발생하는 듯 합니다.

### 12.3.5. 개선 방안

#### 텍스트는 언제나 옳다

- 최대 콘텐츠풀 페인트 지표에서 좋은 점수를 얻는 가장 확실한 방법은 뷰포트 최대 영역, 즉 최대 콘텐츠풀 페인트 예상 영역에 이미지가 아닌 문자열을 넣는 것입니다.
- 아무리 이미지를 최적화 하더라도 추가적인 리소스 다운로드가 필요한 이미지보다 텍스트 노출이 훨씬 더 빠릅니다. 따라서 가능한 한 해당 영역은 텍스트로 채우는 것이 상책입니다.

#### 이미지는 어떻게 불러올 것인가?

- 각 방법들을 살펴보자
  - `<img>`
    - 이미지는 브라우저의 프리로드 스캐너에 의해서 먼저 발견되어 빠르게 요청이 일어나게 됩니ㅏㄷ.
    - 프리로드 스캐너란 HTML을 파싱하는 단계를 차단하지 않고 이미지와 같이 빠르게 미리 로딩하면 좋은 리소스를 먼저 찾아 로딩하는 브라우저의 기능입니다.
    - `<img>` 내부의 리소스를 이처럼 HTML 파싱이 미처 완료되지 않더라도 프리로드 시캐너가 병렬적으로 리소스를 다운로드 하므로 최대 콘텐츠풀 페인트 요소를 불러오기에 적절한 방법입니다.
  - `<svg>` 내부의 `<img>`
    - <s>테스트 결과를 잘 보면 한 가지 흥미로운 결과를 볼 수 있는데, `<img>`가 미처 로딩되지 않은 시점, `<svg>`만 로딩된 시점에 이미 최대 콘텐츠풀 페인트가 완료된 것으로 간주한다는 것입니다.</s>
      픽스되었다고 합니다.
    - 이 외에도 `<img>`와 다른 점이 하나 더 있다면, 바로 모든 리소스를 다 불러온 이후에 이미지를 불러온다는 것입니다.
    - 즉, `<svg>` 내부의 `<img>`는 프리로드 스캐너에 의해 발견되지 않아 병렬적으로 다운로드가 일어나지 않습니다.
      - 결국 점수가 깎이는 악영향을 미치므로 사용하지 않는것이 좋습니다.
  - `<video>`의 poster
    - poster는 사용자가 video 요소를 재생하거나 탐색하기 전까지 노출되는 요소입니다.
    - 이 역시 마찬가지로 프리로드 스캐너에 의해 발견되어 `<img>`와 같은 성능을 나타냅니다.
    - 그리고 향후 poster가 없는 video의 경우 video를 실제로 로딩하여 첫 번째 프레임을 해당 poster 리소스로 대체할 예정이라는 것입니다.
    - 그러므로 video가 최대 콘텐츠풀 페인트에 영향을 받을 것 같다면 poster를 반드시 넣어주는것이 좋습니다.
  - background-image
    - url(): background-image를 비롯해서 CSS에 있는 리소스는 항상 느립니다.
    - 이러한 리소스는 브라우저가 해당 리소스를 필요로 하는 DOM을 그릴 준비가 될 때까지 리소스 요청을 뒤로 미루기 때문입니다.
    - 즉, 최대 콘텐츠풀 페인트에도 좋은 영향을 미치지 않는다는뜻 입니다.
    - 그러므로 가능하다면 background-image는 최대 콘텐츠풀 페인트와 같이 중요한 리소스에는 사용하지 않는 것이 좋습니다.

#### 그 밖에 조심해야 할 사항

- 이미지 무손실 압축
- loading=lazy 주의
  - 최대 콘텐츠풀 콘텐츠의 이미지는 로딩처리를 통해 중요하지 않은 리소스로 분류해서는 안됩니다.
  - 그저 로딩 속도만 늦출 뿐 지표 점수에는 도움이 되지 않습니다.
- fadein과 같은 각종 애니메이션
- 클라이언트에서 빌드하지 말 것
- 최대 콘텐츠풀 리소스는 직접 호스팅

## 12.4. 최초 입력 지연 FID

### 12.4.1. 정의

- 웹사이트의 반응성을 측정하는 지표입니다.
- 최초 입력 지연의 정의는 다음과 같습니다.
  - 사용자가 페이지와 처음 상호작용할 때부터 해당 상호 작용에 대한 응답으로 브라우저가 실제로 이벤트 핸들러 처리를 시작하기까지의 시간을 측정합니다.
- 최대 콘텐츠풀 페인트가 사용자에게 웹사이트의 중요한 콘텐츠를 얼마나 빠르게 노출하는지 측정하는 지표였다면 최초 입력 지연은 사용자가 얼마나 빠르게 웹페이지와의 상호작용에 대한 응답을 받을 수 있는지 측정하는 지표입니다.

### 12.4.2. 의미

- 웹사이트의 내부의 이벤트가 반응이 늦어지는 이유는 무엇일까요?
  - 대부분 해당 입력을 처리해야 하는 브라우저의 메인 스레드가 바쁘기 때문입니다.
  - 메인 스레드가 바쁜 경우, 자바스크립트 실행 환경은 "싱글스레드" 이기 때문에 자바스크립트가 이벤트 리스너와 같은 다른 작업을 실행할 수 없어 지연이 발생합니다.
  - 즉, 이벤트가 발생하는 시점에 최대한 메인 스레드가 다른 작업을 처리할 수 있도록 여유를 만들어 두어야 사용자에게 빠른 반응성을 보장할 수 있습니다.
- 구글은 사용자 경험을 크게 4가지로 분류해 정의하고 있습니다. 이를 RAIL이라고 하며 RAIL에 해당하는 것들은 아래와 같습니다.
  - Response: 사용자의 입력에 대한 반응 속도, 50ms 미만으로 이벤트를 처리할 것
  - Animation: 애니메이션의 각 프레임을 10ms 이하로 생성할 것
  - Idle: 유휴 시간을 극대화하여 페이지가 50ms 이내에 사용자 입력에 응답하도록 할 것
  - Load: 5초 이내에 콘텐츠를 전달하고 인터렉션을 준비할 것
- 이 가운데 최초 입력 지연은 R에 해당하는 응답에 초점을 맞추고 있습니다.

### 12.4.4. 기준 점수

- 최초 입력 지연의 경우 좋은 점수를 얻기 위해서는 1000ms 이내로 응답이 와야 하며, 300ms 이내인 경우 보통, 그 이후의 경우에는 나쁨으로 처리됩니다.

### 12.4.5. 개선 방안

- 최초 입력 지연을 개선하기 위해서는 가장 큰 영향을 미치는 메인 스레드에 이벤트를 실행할 여유를 주어야 합니다.

## 12.5. 누적 레이아웃 이동 (CLS)

### 12.5.1. 정의

- 페이지의 생명주기 동안 발생하는 모든 예기치 않은 이동에 대한 지표롤 계싼하는 것이 누적 레이아웃 이동 입니다.
